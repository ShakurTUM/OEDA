<div class="row">
  <!--Target System Selection, Description, Details Button, Status, Create Experiment Button-->
  <div class="col-md-12">
    <div class="panel panel-default chartJs">
      <div class="panel-heading">
        <div class="card-title">
          <div class="title pull-left">Target System Selection</div>
          <div class="pull-right">
            <div *ngIf="hasChanges() && !hasErrors()" (click)="saveExperiment()" class="btn btn-sm btn-orange"><i
              class="fa fa-send"></i> Create Experiment
            </div>
            <div *ngIf="hasChanges() && hasErrors()" class="btn btn-m btn-danger"><i
              class="fa fa-close"></i> {{errorButtonLabel}}
            </div>
          </div>
        </div>
      </div>
      <div class="panel-body" *ngIf="availableTargetSystems.length > 0" style="padding-top: 20px">
        <div class="row">
          <div class="col-md-3">
            <div class="sub-title">Name</div>
            <div>
                <select class="form-control" required (change)="firstDropDownChanged($event.target.value)">
                  <option disabled>Select target system</option>
                  <option *ngFor="let i of availableTargetSystems;" [ngValue]="i">{{ i.name }}</option>
                </select>
            </div>
          </div>

          <div class="col-md-4" *ngIf="targetSystem.name !== ''">
            <div class="sub-title">Description</div>
            <span>{{targetSystem.description}}</span>
          </div>

          <div class="col-md-3" *ngIf="targetSystem.name !== ''">
            <div class="sub-title">Details</div>
            <button type="button" class="btn btn-orange"
                    (click)="is_collapsed = !is_collapsed">
              <span *ngIf="is_collapsed">Show</span>
              <i *ngIf="is_collapsed" class="fa fa-angle-double-down" aria-hidden="true"></i>

              <span *ngIf="!is_collapsed">Hide</span>
              <i *ngIf="!is_collapsed" class="fa fa-angle-double-up" aria-hidden="true"></i>
            </button>
          </div>

          <div class="col-md-2" *ngIf="targetSystem.name !== ''">
            <div class="sub-title">Status</div>
            <label *ngIf="targetSystem.status == 'READY'" class="label label-success">READY</label>
            <label *ngIf="targetSystem.status == 'WORKING'" class="label label-info">WORKING</label>
            <label *ngIf="targetSystem.status == 'ERROR'" class="label label-danger">ERROR</label>
          </div>
        </div>
      </div>
      <div class="panel-body" *ngIf="availableTargetSystems.length == 0" style="padding-top: 20px">
        <div class="row">
          <div class="col-md-6">
            <div class="sub-title">There is no available target system
              <a (click)="navigateToTargetSystemPage()"> please create one here </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!--Experiment Parameters-->
  <div class="col-md-12" *ngIf="targetSystem.name !== ''">
    <div class="panel panel-default chartJs">
      <div class="panel-heading">
        <div class="card-title">
          <div class="title pull-left">Experiment Parameters</div>
        </div>
      </div>
      <div class="panel-body">
        <div class="row">
          <labeled-input name="Experiment Name (required)" [model]="experiment" key="name" [colSize]="6"
                         data-toggle="tooltip" title="Please provide a name"></labeled-input>
          <labeled-input name="Experiment Description" [model]="experiment" key="description" [required]="false" [colSize]="6"></labeled-input>
        </div>
      </div>
    </div>
  </div>

  <!-- Primary Data Provider & Secondary Data Provider(s)-->
  <div class="col-md-12" *ngIf="targetSystem.name !== ''" [hidden]="is_collapsed">

    <div class="col-sm-6" style="padding-left: 0">
      <div class="panel panel-default chartJs">
        <div class="panel-heading">
          <div class="card-title">
            <div class="title pull-left">Primary Data Provider</div>
          </div>
        </div>
        <div class="panel-body" style="padding-top: 20px">
          <div class="row" *ngIf="targetSystem.primaryDataProvider.type == 'http_request'">
            <div class="col-md-3">
              <div class="sub-title">Name</div>
              <span>{{targetSystem.primaryDataProvider.name}}</span>
            </div>
            <div class="col-md-2">
              <div class="sub-title">URL</div>
              <span>{{targetSystem.primaryDataProvider.url}}</span>
            </div>
            <div class="col-md-2">
              <div class="sub-title">Port</div>
              <span>{{targetSystem.primaryDataProvider.port}}</span>
            </div>
            <div class="col-md-3">
              <div class="sub-title">Serializer</div>
              <span>{{targetSystem.primaryDataProvider.serializer}}</span>
            </div>
            <div class="col-md-2">
              <div class="sub-title">Ignore First N Samples</div>
              <span>{{targetSystem.primaryDataProvider.ignore_first_n_samples}}</span>
            </div>
          </div>

          <div class="row" *ngIf="targetSystem.primaryDataProvider.type == 'kafka_consumer'">
            <div class="col-md-3">
              <div class="sub-title">Name</div>
              <span>{{targetSystem.primaryDataProvider.name}}</span>
            </div>
            <div class="col-md-2">
              <div class="sub-title">Kafka URI</div>
              <span>{{targetSystem.primaryDataProvider.kafka_uri}}</span>
            </div>
            <div class="col-md-2">
              <div class="sub-title">Topic</div>
              <span>{{targetSystem.primaryDataProvider.topic}}</span>
            </div>
            <div class="col-md-3">
              <div class="sub-title">Serializer</div>
              <span>{{targetSystem.primaryDataProvider.serializer}}</span>
            </div>
            <div class="col-md-2">
              <div class="sub-title">Ignore First N Samples</div>
              <span>{{targetSystem.primaryDataProvider.ignore_first_n_samples}}</span>
            </div>
          </div>

          <div class="row" *ngIf="targetSystem.primaryDataProvider.type == 'mqtt_listener'">
            <div class="col-md-2">
              <div class="sub-title">Name</div>
              <span>{{targetSystem.primaryDataProvider.name}}</span>
            </div>
            <div class="col-md-3">
              <div class="sub-title">Host</div>
              <span>{{targetSystem.primaryDataProvider.host}}</span>
            </div>
            <div class="col-md-2">
              <div class="sub-title">Port</div>
              <span>{{targetSystem.primaryDataProvider.port}}</span>
            </div>
            <div class="col-md-2">
              <div class="sub-title">Topic</div>
              <span>{{targetSystem.primaryDataProvider.topic}}</span>
            </div>
            <div class="col-md-1">
              <div class="sub-title">Serializer</div>
              <span>{{targetSystem.primaryDataProvider.serializer}}</span>
            </div>
            <div class="col-md-2">
              <div class="sub-title">Ignore First N Samples</div>
              <span>{{targetSystem.primaryDataProvider.ignore_first_n_samples}}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Secondary Data Provider(s) -->
      <div class="panel panel-default chartJs" *ngIf="targetSystem.secondaryDataProviders.length > 0">
        <div class="panel-heading">
          <div class="card-title">
            <div class="title pull-left" *ngIf="targetSystem.secondaryDataProviders.length > 1">Secondary Data Providers</div>
            <div class="title pull-left" *ngIf="targetSystem.secondaryDataProviders.length == 1">Secondary Data Provider</div>
          </div>
        </div>
        <div class="panel-body" style="padding-top: 20px">
          <div class="row" *ngFor="let secondaryDataProvider of targetSystem.secondaryDataProviders">
            <div *ngIf="secondaryDataProvider.type == 'http_request'">
              <div class="col-md-3">
                <div class="sub-title">Name</div>
                <span>{{secondaryDataProvider.name}}</span>
              </div>
              <div class="col-md-3">
                <div class="sub-title">URL</div>
                <span>{{secondaryDataProvider.url}}</span>
              </div>
              <div class="col-md-3">
                <div class="sub-title">Port</div>
                <span>{{secondaryDataProvider.port}}</span>
              </div>
              <div class="col-md-3">
                <div class="sub-title">Serializer</div>
                <span>{{secondaryDataProvider.serializer}}</span>
              </div>
            </div>

            <div *ngIf="secondaryDataProvider.type == 'kafka_consumer'">
              <div class="col-md-3">
                <div class="sub-title">Name</div>
                <span>{{secondaryDataProvider.name}}</span>
              </div>
              <div class="col-md-3">
                <div class="sub-title">Kafka URI</div>
                <span>{{secondaryDataProvider.kafka_uri}}</span>
              </div>
              <div class="col-md-3">
                <div class="sub-title">Topic</div>
                <span>{{secondaryDataProvider.topic}}</span>
              </div>
              <div class="col-md-3">
                <div class="sub-title">Serializer</div>
                <span>{{secondaryDataProvider.serializer}}</span>
              </div>
            </div>

            <div *ngIf="secondaryDataProvider.type == 'mqtt_listener'">
              <div class="col-md-2">
                <div class="sub-title">Name</div>
                <span>{{secondaryDataProvider.name}}</span>
              </div>
              <div class="col-md-3">
                <div class="sub-title">Host</div>
                <span>{{secondaryDataProvider.host}}</span>
              </div>
              <div class="col-md-3">
                <div class="sub-title">Port</div>
                <span>{{secondaryDataProvider.port}}</span>
              </div>
              <div class="col-md-3">
                <div class="sub-title">Topic</div>
                <span>{{secondaryDataProvider.topic}}</span>
              </div>
              <div class="col-md-1">
                <div class="sub-title">Serializer</div>
                <span>{{secondaryDataProvider.serializer}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Change Provider -->
    <div class="col-sm-6" style="padding-right: 0">
      <div class="panel panel-default chartJs">
        <div class="panel-heading">
          <div class="card-title">
            <div class="title pull-left">Change Provider</div>
          </div>
        </div>
        <div class="panel-body" style="padding-top: 20px">

          <div class="row" *ngIf="targetSystem.changeProvider.type == 'http_request'">
            <div class="col-md-4">
              <div class="sub-title">URL</div>
              <span>{{targetSystem.changeProvider.url}}</span>
            </div>
            <div class="col-md-4">
              <div class="sub-title">Port</div>
              <span>{{targetSystem.changeProvider.port}}</span>
            </div>
            <div class="col-md-4">
              <div class="sub-title">Serializer</div>
              <span>{{targetSystem.changeProvider.serializer}}</span>
            </div>
          </div>

          <div class="row" *ngIf="targetSystem.changeProvider.type == 'kafka_producer'">
            <div class="col-md-4">
              <div class="sub-title">Kafka URI</div>
              <span>{{targetSystem.changeProvider.kafka_uri}}</span>
            </div>
            <div class="col-md-4">
              <div class="sub-title">Topic</div>
              <span>{{targetSystem.changeProvider.topic}}</span>
            </div>
            <div class="col-md-4">
              <div class="sub-title">Serializer</div>
              <span>{{targetSystem.changeProvider.serializer}}</span>
            </div>
          </div>

          <div class="row" *ngIf="targetSystem.changeProvider.type == 'mqtt_listener'">
            <div class="col-md-3">
              <div class="sub-title">Host</div>
              <span>{{targetSystem.changeProvider.host}}</span>
            </div>
            <div class="col-md-3">
              <div class="sub-title">Port</div>
              <span>{{targetSystem.changeProvider.port}}</span>
            </div>
            <div class="col-md-3">
              <div class="sub-title">Topic</div>
              <span>{{targetSystem.changeProvider.topic}}</span>
            </div>
            <div class="col-md-3">
              <div class="sub-title">Serializer</div>
              <span>{{targetSystem.changeProvider.serializer}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Incoming Data Types -->
  <div class="col-md-12" *ngIf="targetSystem.name !== ''">
    <div class="panel panel-default chartJs">
      <div class="panel-heading">
        <div class="card-title">
          <div class="title pull-left">Incoming Data Types</div>
        </div>
      </div>
      <div class="panel-body" style="padding-top: 20px">
        <table class="table table-striped table-bordered table-hover">
          <thead>
            <th style="padding-left: 1%">Name</th>
            <th style="padding-left: 1%">Scale</th>
            <th style="padding-left: 1%">Description</th>
            <th style="padding-left: 1%">Data Provider Name</th>
            <th style="padding-left: 1%">Optimization Criteria</th>
            <th style="padding-left: 1%">Consider</th>
          </thead>
          <tbody>
          <tr *ngFor="let dataType of targetSystem.incomingDataTypes" style="padding-top: 1%">
            <td>{{dataType.name}}</td>
            <td>{{dataType.scale}}</td>
            <td>{{dataType.description}}</td>
            <td>{{dataType.dataProviderName}}</td>
            <td>{{dataType.criteria}}</td>
            <td>
              <input type="checkbox" class="form-check-input"
                     [(ngModel)]="dataType['is_optimized']"
                     data-toggle="tooltip"
                     title="Select one incoming data type to be optimized">
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!--Changeable Variables -->
  <div class="col-md-12" *ngIf="targetSystem.name !== ''">
    <div class="panel panel-default chartJs">
      <div class="panel-heading">
        <div class="card-title">
          <div class="title pull-left">Changeable Variables</div>
        </div>
      </div>
      <div class="panel-body" style="padding-top: 20px">
        <div class="table-responsive">
          <table class="table table-striped table-bordered table-hover">
            <thead>
            <th style="width: 5%">Name</th>
            <th style="width: 5%">Scale</th>
            <th style="width: 5%">Description</th>
            <th style="width: 5%">Min</th>
            <th style="width: 5%">Max</th>
            <th style="width: 4%">
              <div class="btn btn-xs btn-orange" (click)="addAllChangeableVariables()"
                   *ngIf="targetSystem.changeableVariable.length > 1 && targetSystem.changeableVariable.length != experiment.changeableVariable.length">
                <i class="fa fa-plus push-5-r"></i> Add All
              </div>
            </th>
            </thead>
            <tbody>
            <tr *ngFor="let dataType of targetSystem.changeableVariable" style="padding-top: 1%">
              <td style="padding-top: 2%">{{dataType.name}}</td>
              <td style="padding-top: 2%">{{dataType.scale}}</td>
              <td style="padding-top: 2%; width: 5%">{{dataType.description}}</td>
              <td style="padding-top: 2%">{{dataType.min}}</td>
              <td style="padding-top: 2%; width: 5%">{{dataType.max}}</td>
              <td style="padding-top: 2%">
                <div class="btn btn-xs btn-orange" (click)="addChangeableVariable(dataType)"
                     *ngIf="targetSystem.changeableVariable.length > 0 && targetSystem.changeableVariable.length != experiment.changeableVariable.length">
                  <i class="fa fa-plus push-5-r"></i> Add
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!--Execution Strategy & Added Variables-->
  <div class="col-md-12" *ngIf="targetSystem.name !== '' && experiment.changeableVariable.length > 0" >

    <!-- Execution Strategy is allowed to be selected after adding some variables to experiment -->
    <div class="col-md-3" style="padding-left: 0">
      <div class="panel panel-default chartJs">
        <div class="panel-heading">
          <div class="card-title">
            <div class="title pull-left">Execution Strategy</div>
            <div class="title pull-right">
              <a data-toggle="modal" data-target="#infoModal"><i class="fa fa-info fa-lg"></i></a>
            </div>
          </div>
        </div>
        <div class="panel-body" style="padding-top: 20px">
          <labeled-input-select name="Type" [model]="experiment.executionStrategy" key="type" [colSize]="12"
                                [options]="[
                                    {key:'step_explorer',label:'Step Strategy'},
                                    {key:'random',label:'Random Strategy'},
                                    {key:'forever',label:'Forever Strategy'},
                                    {key:'sequential_strategy',label:'Sequential Strategy'},
                                    {key:'self_optimizer',label:'Self Optimizer Strategy'},
                                    {key:'mlr_mbo',label:'mlrMBO Strategy'},
                                    {key:'uncorrelated_self_optimizer',label:'Uncorrelated Self Optimizer Strategy'}]"
                                (modelChanged)="executionStrategyModelChanged($event)">
          </labeled-input-select>
          <labeled-input inputType="number" name="Sample Size" [model]="experiment.executionStrategy" key="sample_size" [colSize]="12" [minNumber]="1"></labeled-input>
          <div *ngIf="experiment.executionStrategy.type == 'random' || experiment.executionStrategy.type == 'mlr_mbo' || experiment.executionStrategy.type == 'self_optimizer' || experiment.executionStrategy.type == 'uncorrelated_self_optimizer'" >
            <labeled-input inputType="number" name="Optimizer Iterations" [model]="experiment.executionStrategy" key="optimizer_iterations" [colSize]="12" [minNumber]="1"></labeled-input>
            <labeled-input inputType="number" name="Optimizer Iterations in Design" [model]="experiment.executionStrategy" key="optimizer_iterations_in_design" [colSize]="12" [minNumber]="0"></labeled-input>
          </div>
          <div *ngIf="experiment.executionStrategy.type == 'self_optimizer'">
            <labeled-input inputType="text" name="Optimizer Method" [model]="experiment.executionStrategy" key="optimizer_method" [colSize]="12"></labeled-input>
          </div>
          <div *ngIf="experiment.executionStrategy.type == 'step_explorer' && stages_count !== null">
            <div class="col-md-12">
              <div class="sub-title">Total Number of Stages</div>
              <div>
                <input class="form-control" type="number" [disabled]="true" [value]=stages_count>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Added Variables -->
    <div class="col-md-9" style="padding-right: 0">
      <div class="panel panel-default chartJs">
        <div class="panel-heading">
          <div class="card-title">
            <div class="title pull-left">Added Variables</div>
            <div class="pull-right">
              <div class="btn btn-xs btn-primary" (click)="removeAllVariables()"
                   *ngIf="targetSystem.changeableVariable.length > 1 && experiment.changeableVariable.length > 1">
                <i class="fa fa-remove"></i> Remove All
              </div>
            </div>
          </div>
        </div>
        <div class="panel-body" style="padding-top: 20px">
          <div class="row" *ngFor="let input of experiment.changeableVariable; let i = index">
            <div class="row">
              <div class="row" style="padding-left: 5%">
                <labeled-input name="Name" [model]="input" key="name" [colSize]="3" disabled="true"></labeled-input>
                <labeled-input inputType="number" name="Min" [model]="input" key="min" [colSize]="2" (modelChanged)="minMaxModelsChanged($event)"></labeled-input>
                <labeled-input inputType="number" name="Max" [model]="input" key="max" [colSize]="2" (modelChanged)="minMaxModelsChanged($event)"></labeled-input>
                <labeled-input inputType="number" name="Default" [model]="input" key="default" [colSize]="2" disabled="true"></labeled-input>
                <labeled-input *ngIf="experiment.executionStrategy.type == 'step_explorer'" inputType="number" name="Step Size" [model]="input" key="step" [colSize]="2" (modelChanged)="stepSizeChanged($event)"></labeled-input>
                <div class="col-sm-1">
                  <div class="sub-title">
                    <div>
                      <div (click)="removeChangeableVariable(i, input)" class="btn btn-xs btn-primary"><i class="fa fa-remove"></i> Remove</div>
                    </div>
                  </div>
                </div>
              </div>
              <hr class="col-md-12">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Info modal for Execution Strategies -->
    <div class="modal fade bd-example-modal-sm" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
      <div class="col-md-12">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title" id="modalTitle">Execution Strategies</h3>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p>Execution strategies define the experimentation process, i.e. specify how multiple
                experiments are to be performed.</p>
              <p>OEDA supports following strategies:</p>
              <hr>
              <p><b>Step: </b>Goes through the specified ranges of changeable variables</p>
              <hr>

              <p><b>Random: </b>Randomly picks values within specified ranges of changeable variables</p>
              <hr>

              <p><b>Forever: </b>Uses default values of the simulation and runs the experimentation process forever</p>
              <hr>

              <p><b>Sequential: </b>Runs a list of experiments one after another</p>
              <hr>

              <p><b>Self Optimizer: </b>Runs multiple experiments and tries to find the best value for the knobs
                using <a target="_blank" href="http://scikit-learn.org">scikit-learn's</a> Bayesian optimization with Gaussian Processes</p>
              <hr>

              <p><b>Uncorrelated Self Optimizer:</b>Instead of finding best values for all knobs at the same time,
                it tries to find the best value for one variable at each experimentation</p>
              <hr>

              <p><b>mlr MBO:</b> Optimizes expensive black-box functions by model-based optimization
                using  <a target="_blank" href="https://mlr-org.github.io/mlrMBO/articles/mlrMBO.html">mlrMBO</a> that is based on machine learning library written in R</p>
              <hr>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
  <debug-element [element]="experiment"></debug-element>
</div>
